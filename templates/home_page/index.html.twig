{% extends 'base.html.twig' %}

{% block title %}SHARR .{% endblock %}

{% block body %}
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #highlighting, #txtInput {
            line-height: 1.5rem;
            font-family: 'ui-monospace', monospace;
            tab-size: 4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .token-keyword { color: #569cd6; font-weight: bold; }
        .token-type { color: #4ec9b0; }
        .token-function { color: #dcdcaa; }
        .token-variable { color: #9cdcfe; }
        .token-string { color: #ce9178; }
        .token-comment { color: #6a9955; font-style: italic; }
        .token-number { color: #b5cea8; }
    </style>
</head>

<div class="fixed inset-0 flex flex-col bg-[#1e1e1e] text-white">
    
    <header class="h-16 flex items-center justify-between px-6 bg-[#252526] border-b border-[#333] relative z-[100]">
        <span class="text-2xl font-mono font-black tracking-tighter hover:opacity-80 transition">
            SHARR<span class="text-blue-500">.</span>
        </span>

        <div class="flex items-center gap-4">
            <div id="status-dot" class="flex items-center gap-2 text-[10px] font-mono text-gray-500 bg-[#2d2d2d] px-3 py-1 rounded-full border border-[#444]">
                <div id="dot" class="w-2 h-2 rounded-full bg-yellow-500"></div>
                <span id="status-text">INITIALISATION...</span>
            </div>

            <div class="relative">
                <button onclick="toggleMenu()" class="text-2xl p-2 rounded hover:bg-[#37373d] transition focus:outline-none">‚ò∞</button>
                <div id="dropdown" class="hidden absolute right-0 mt-2 w-64 bg-[#252526] border border-[#454545] rounded shadow-2xl overflow-hidden">
                    <div class="p-3 bg-[#2d2d2d] text-xs font-bold text-gray-400 uppercase tracking-widest">Historique</div>
                    <div class="max-h-48 overflow-y-auto">
                        <a href="#" class="block p-3 text-sm hover:bg-[#37373d] border-b border-[#333] text-blue-400 font-mono italic text-xs">share.fr/{{ token }}</a>
                    </div>
                    <button onclick="openModal()" class="w-full text-left p-3 text-sm hover:bg-[#37373d] transition flex items-center gap-2">‚ùì Comment √ßa marche</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-[#1e1e1e] flex">
        <div id="line-numbers" class="w-12 bg-[#1e1e1e] text-[#858585] text-right pr-4 pt-8 font-mono text-base select-none border-r border-[#333] z-10">
            <div>1</div>
        </div>

        <div class="flex-1 relative">
            <pre id="highlighting" aria-hidden="true" 
                 class="absolute inset-0 pt-8 pl-4 m-0 pointer-events-none overflow-hidden text-[#d4d4d4] z-0"></pre>
            
            <textarea
                id="txtInput"
                class="absolute inset-0 w-full h-full pt-8 pl-4 bg-transparent text-transparent caret-white font-mono text-base resize-none outline-none border-none focus:ring-0 z-10 selection:bg-[#264f78]/50"
                spellcheck="false"
                placeholder="// Initialisation..."
                readonly
            >{{ codeSpace.txtInput }}</textarea>
        </div>

        <div id="readonly-badge" class="hidden absolute bottom-4 right-6 z-50 bg-blue-600/20 border border-blue-500/50 text-blue-400 text-[10px] px-3 py-1 rounded-full font-mono items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></div>
            MODE LECTURE SEULE
        </div>
    </main>
</div>

<div id="modal" class="fixed inset-0 bg-black/70 items-center justify-center z-[200] hidden flex">
    <div class="bg-[#252526] rounded-lg max-w-lg w-full mx-4 border border-[#454545] shadow-2xl">
        <div class="p-6 border-b border-[#333]"><h2 class="text-xl font-bold">Pourquoi Sharr ?</h2></div>
        <div class="p-6 text-gray-400 text-sm space-y-4">
            <p>Sharr permet au formateur de partager son code instantan√©ment. Les √©l√®ves suivent en temps r√©el.</p>
            <p class="bg-[#1e1e1e] p-3 rounded border border-[#333] font-mono text-blue-400">share.fr/{{ token }}</p>
        </div>
        <div class="p-4 bg-[#2d2d2d] flex justify-end">
            <button onclick="closeModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold transition">OK</button>
        </div>
    </div>
</div>

<script>
    // --- G√âN√âRATION D'UN ID UNIQUE PAR NAVIGATEUR ---
    function getClientId() {
        let clientId = localStorage.getItem('sharr_client_id');
        if (!clientId) {
            clientId = 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('sharr_client_id', clientId);
        }
        return clientId;
    }

    // --- VARIABLES GLOBALES ---
    const input = document.getElementById('txtInput');
    const highlighting = document.getElementById('highlighting');
    const lineNumbersEle = document.getElementById('line-numbers');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('status-text');
    const readonlyBadge = document.getElementById('readonly-badge');
    const clientId = getClientId();
    
    let isWriter = false;
    let isReadOnly = true;
    let pollInterval = null;
    let initialized = false;

    console.log('Mon Client ID:', clientId);

    // --- INTERFACE ---
    function toggleMenu() { document.getElementById('dropdown').classList.toggle('hidden'); }
    function openModal() { document.getElementById('modal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    // --- MOTEUR DE COLORATION ---
    function updateEditor() {
        let code = input.value;
        const lines = code.split('\n').length;
        lineNumbersEle.innerHTML = Array.from({length: lines}, (_, i) => `<div>${i + 1}</div>`).join('');

        let html = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        html = html
            .replace(/\/\/(.*)/g, '<span class="token-comment">//$1</span>')
            .replace(/"(.*?)"/g, '<span class="token-string">"$1"</span>')
            .replace(/'(.*?)'/g, '<span class="token-string">\'$1\'</span>')
            .replace(/\b(function|return|if|else|for|while|class|public|private|protected|static|new|use|namespace|const|let|var)\b/g, '<span class="token-keyword">$1</span>')
            .replace(/\b(int|string|bool|boolean|float|void|array|object|iterable|mixed|any|number)\b/g, '<span class="token-type">$1</span>')
            .replace(/\b(\d+)\b/g, '<span class="token-number">$1</span>')
            .replace(/\b(\w+)(?=\()/g, '<span class="token-function">$1</span>')
            .replace(/\$([a-zA-Z0-9_]+)/g, '<span class="token-variable">$$$1</span>');

        highlighting.innerHTML = html + (code.endsWith('\n') ? ' ' : '');
    }

    // --- CLAIM WRITER D√àS LE D√âPART ---
    async function claimWriterStatus() {
        try {
            const response = await fetch(`/{{ token }}/claim-writer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientId: clientId })
            });

            const data = await response.json();
            console.log('Claim writer result:', data);

            if (data.isWriter) {
                switchToWriter();
            } else {
                switchToReader();
                // D√©marrer le polling imm√©diatement pour les lecteurs
                pollInterval = setInterval(pollUpdates, 2000);
                pollUpdates(); // Premier appel imm√©diat
            }

            initialized = true;

        } catch (error) {
            console.error('Erreur claim writer:', error);
            // En cas d'erreur, on reste en lecture seule par s√©curit√©
            switchToReader();
        }
    }

    // --- SYNCHRONISATION ---
    function sendToServer() {
        if (isReadOnly || !isWriter) {
            console.log('Bloqu√©: mode lecture seule');
            return;
        }

        dot.style.backgroundColor = '#eab308';
        statusText.innerText = "SYNCHRONISATION...";

        fetch(`/{{ token }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ 
                champ: input.value,
                clientId: clientId 
            })
        })
        .then(res => res.json())
        .then(data => {
            console.log('R√©ponse serveur:', data);
            if (data.status === 'error') {
                console.log('Erreur serveur, passage en mode lecteur');
                switchToReader();
                if (!pollInterval) {
                    pollInterval = setInterval(pollUpdates, 2000);
                }
            } else {
                dot.style.backgroundColor = '#22c55e';
                statusText.innerText = "√âDITEUR";
            }
        })
        .catch(err => {
            console.error('Erreur:', err);
            dot.style.backgroundColor = '#ef4444';
            statusText.innerText = "ERREUR";
        });
    }

    // --- POLLING POUR LES LECTEURS ---
    function pollUpdates() {
        if (!isReadOnly) return; // Ne poll que si on est lecteur

        fetch(`/{{ token }}/poll?clientId=${clientId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Mettre √† jour le contenu
                    input.value = data.content || '';
                    updateEditor();
                    
                    if (data.isFinished) {
                        clearInterval(pollInterval);
                        statusText.innerText = "SESSION TERMIN√âE";
                        dot.style.backgroundColor = "#6b7280";
                    }
                }
            })
            .catch(error => {
                console.error('Erreur polling:', error);
            });
    }

    // --- BASCULER EN MODE WRITER ---
    function switchToWriter() {
        console.log('‚úÖ Je suis WRITER');
        isWriter = true;
        isReadOnly = false;
        input.removeAttribute('readonly');
        input.placeholder = '// Tape ton code ici...';
        dot.style.backgroundColor = '#22c55e';
        statusText.innerText = "√âDITEUR";
        readonlyBadge.classList.add('hidden');
        readonlyBadge.classList.remove('flex');
    }

    // --- BASCULER EN MODE READER ---
    function switchToReader() {
        console.log('üëÅÔ∏è Je suis LECTEUR');
        isWriter = false;
        isReadOnly = true;
        input.setAttribute('readonly', 'readonly');
        input.placeholder = '// En attente du formateur...';
        dot.style.backgroundColor = '#3b82f6';
        statusText.innerText = "LECTEUR";
        readonlyBadge.classList.remove('hidden');
        readonlyBadge.classList.add('flex');
    }

    function debounce(func, wait) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    const debouncedUpdate = debounce(sendToServer, 400);

    // --- √âV√âNEMENTS D'√âCRITURE ---
    input.addEventListener('input', () => {
        updateEditor();
        if (!isReadOnly && isWriter) {
            debouncedUpdate();
        }
    });

    input.addEventListener('keydown', function(e) {
        if (isReadOnly) {
            e.preventDefault(); // Bloquer toute frappe en mode lecture
            return;
        }
        
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            this.value = this.value.substring(0, start) + "    " + this.value.substring(this.selectionEnd);
            this.selectionStart = this.selectionEnd = start + 4;
            updateEditor();
            debouncedUpdate();
        }
    });

    // --- SCROLL SYNCHRONIS√â ---
    input.addEventListener('scroll', () => {
        highlighting.scrollTop = input.scrollTop;
        highlighting.scrollLeft = input.scrollLeft;
        lineNumbersEle.scrollTop = input.scrollTop;
    });

    // --- FERMETURE DE LA SESSION ---
    window.addEventListener('beforeunload', () => {
        if (isWriter && !isReadOnly) {
            const data = JSON.stringify({ 
                isFinished: true,
                clientId: clientId 
            });
            const blob = new Blob([data], { type: 'application/json' });
            navigator.sendBeacon(`/{{ token }}`, blob);
        }
    });

    // --- INITIALISATION ---
    updateEditor();
    
    // CLAIM LE STATUT D√àS LE CHARGEMENT
    claimWriterStatus();
</script>
{% endblock %}